<div class="h-full min-h-0 flex flex-col">
    <div class="mb-4 flex flex-wrap gap-3">
        <button type="button" class="rounded-full border px-4 py-2 text-sm font-semibold transition cursor-pointer"
            [ngClass]="{ 'bg-[#315f92] text-white border-[#315f92]': mode === 'create',
                         'bg-white text-[#315f92] border-[#315f92]/40': mode !== 'create' }"
            (click)="switchToCreate()">
            {{ getPlanAlimentaireFormTitle() }}
        </button>

        <button type="button" class="rounded-full border px-4 py-2 text-sm font-semibold transition cursor-pointer"
            [ngClass]="{ 'bg-[#315f92] text-white border-[#315f92]': mode === 'manage',
                         'bg-white text-[#315f92] border-[#315f92]/40': mode !== 'manage' }"
            (click)="switchToManage()">
            Voir / supprimer
        </button>
    </div>

    <div *ngIf="mode === 'create'" class="rounded-2xl border border-[#e1e9f5] bg-[#f5f7fb] p-3 shadow-inner mb-6">
        <h3 class="text-lg font-semibold text-[#315f92] mb-2">
            {{ getPlanAlimentaireFormTitle() }}
        </h3>

        <label class="block text-sm font-semibold text-[#315f92] mb-2">Titre</label>
        <input type="text" [(ngModel)]="planAlimentaireTitre" placeholder="Ex : Plan alimentaire du 14/10 - Objectifs"
            class="mb-3 w-full rounded-xl border border-[#315f92]/30 bg-white px-3 py-2 text-sm text-[#315f92] focus:border-[#315f92] focus:outline-none" />

        <div class="mb-2 flex flex-wrap gap-2">
            <button type="button"
                class="rounded-md border px-3 py-1 text-sm text-[#315f92] hover:bg-white cursor-pointer"
                (click)="exec('bold')">Gras</button>
            <button type="button"
                class="rounded-md border px-3 py-1 text-sm text-[#315f92] hover:bg-white cursor-pointer"
                (click)="exec('italic')">Italique</button>
            <button type="button"
                class="rounded-md border px-3 py-1 text-sm text-[#315f92] hover:bg-white cursor-pointer"
                (click)="exec('underline')">Souligné</button>

            <span class="mx-2 inline-block w-px bg-[#d9e2f3]"></span>

            <button type="button"
                class="rounded-md border px-3 py-1 text-sm text-[#315f92] hover:bg-white cursor-pointer"
                (click)="exec('justifyLeft')">Gauche</button>
            <button type="button"
                class="rounded-md border px-3 py-1 text-sm text-[#315f92] hover:bg-white cursor-pointer"
                (click)="exec('justifyCenter')">Centre</button>
            <button type="button"
                class="rounded-md border px-3 py-1 text-sm text-[#315f92] hover:bg-white cursor-pointer"
                (click)="exec('justifyRight')">Droite</button>
        </div>

        <label class="block text-sm font-semibold text-[#315f92] mb-2">Contenu</label>
        <div #editor contenteditable="true" (input)="onEditorInput()"
            class="h-[30vh] overflow-y-auto w-full rounded-xl border border-[#315f92]/30 bg-white px-3 py-2
                text-sm text-[#315f92] focus-within:border-[#315f92] focus:outline-none whitespace-pre-wrap break-words">
        </div>

        <div class="mt-3 flex flex-wrap items-center gap-3">
            <button *ngIf="!planAlimentaireId" type="button" (click)="handlePlanAlimentaire()"
                [disabled]="planAlimentaireLoading"
                class="rounded-full bg-[#315f92] px-5 py-2 text-sm font-semibold text-white transition hover:bg-[#24476e] disabled:opacity-60 cursor-pointer">
                {{ getCreateButtonLabel() }}
            </button>

            <button *ngIf="planAlimentaireId" type="button" (click)="updatePlanAlimentaire()"
                class="rounded-full bg-[#315f92] px-5 py-2 text-sm font-semibold text-white transition hover:bg-[#24476e] cursor-pointer">
                Enregistrer les modifications
            </button>

            <button *ngIf="planAlimentaireId" type="button" (click)="cancelEdit()"
                class="rounded-full border border-[#315f92] px-5 py-2 text-sm font-semibold text-[#315f92] transition hover:bg-[#315f92]/10 cursor-pointer">
                Annuler
            </button>

            <span *ngIf="planAlimentaireSucces" class="text-sm font-semibold text-green-600">{{ planAlimentaireSucces
                }}</span>
            <span *ngIf="planAlimentaireError" class="text-sm font-semibold text-red-600">{{ planAlimentaireError
                }}</span>
        </div>
    </div>

    <div *ngIf="mode === 'manage'" class="space-y-4 flex-1 min-h-0 overflow-y-auto pr-2">
        <p class="text-sm text-[#527bab]" *ngIf="listLoading">Chargement…</p>
        <p class="rounded-xl border border-red-200 bg-red-50 px-4 py-2 text-sm text-red-700" *ngIf="listError">{{
            listError }}</p>
        <p class="text-sm text-[#527bab]" *ngIf="!listLoading && items.length === 0 && !listError">
            Aucun “cette semaine” pour cet utilisateur.
        </p>

        <article *ngFor="let item of items"
            class="rounded-2xl border border-[#e1e9f5] bg-white p-4 text-[#315f92] shadow-sm">
            <header class="mb-3 flex flex-wrap items-center justify-between gap-2">
                <h4 class="text-base font-semibold">{{ getPlanAlimentaireItemTitle(item) }}</h4>

                <div class="flex items-center gap-2">
                    <button type="button"
                        class="rounded-full border border-[#315f92]/30 bg-white px-3 py-1 text-sm text-[#315f92] transition hover:bg-[#315f92]/10 cursor-pointer"
                        (click)="startEdit(item)">
                        Modifier
                    </button>

                    <button type="button"
                        class="rounded-full border border-red-300 bg-white px-3 py-1 text-sm text-red-600 transition hover:bg-red-50 cursor-pointer"
                        (click)="openDeletePlanAlimentaire(item)">
                        Supprimer
                    </button>
                </div>
            </header>

            <div #PlanAlimentaireContentHost
                class="prose max-w-none prose-p:my-2 prose-ul:list-disc prose-ol:list-decimal prose-li:my-1"></div>
        </article>
    </div>

    <div *ngIf="deleteConfirmOpen" class="fixed inset-0 z-[210] flex items-center justify-center bg-black/60 px-4"
        (click)="cancelDeletePlanAlimentaire()">
        <div class="w-full max-w-md rounded-2xl bg-white p-6 text-[#315f92] shadow-2xl"
            (click)="$event.stopPropagation()">
            <h3 class="text-lg font-semibold">Confirmer la suppression</h3>
            <p class="mt-3 text-sm text-[#527bab]">{{ getDeletePlanAlimentaireLabel() }}</p>
            <p *ngIf="deleteError" class="mt-2 text-sm font-semibold text-red-600">{{ deleteError }}</p>
            <div class="mt-6 flex flex-wrap justify-end gap-3">
                <button type="button"
                    class="rounded-full border border-[#315f92] px-4 py-2 text-sm font-semibold text-[#315f92] transition hover:bg-[#315f92]/10"
                    (click)="cancelDeletePlanAlimentaire()">Annuler</button>
                <button type="button"
                    class="rounded-full bg-red-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-red-700"
                    (click)="confirmDeletePlanAlimentaire()">Supprimer</button>
            </div>
        </div>
    </div>
</div>