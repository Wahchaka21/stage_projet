<div class="plan-client-root">
    <div class="mode-switch">
        <button type="button" [class.active]="mode === 'create'" (click)="switchToCreate()">
            Creer un plan client
        </button>
        <button type="button" [class.active]="mode === 'manage'" (click)="switchToManage()">
            Gerer les plans
        </button>
    </div>

    <section *ngIf="mode === 'create'" class="create-panel">
        <h3>Informations du plan</h3>
        <label class="field">
            <span>Titre</span>
            <input type="text" [(ngModel)]="planClientTitre" placeholder="Ex : Seance 1" />
        </label>

        <div class="messages">
            <p *ngIf="planClientSuccess" class="msg success">{{ planClientSuccess }}</p>
            <p *ngIf="planClientError" class="msg error">{{ planClientError }}</p>
        </div>

        <div class="exercise-actions">
            <button type="button" (click)="addNewExercise()">+ Ajouter un exercice</button>
        </div>

        <p *ngIf="newExercises.length === 0" class="empty-hint">
            Cliquez sur le bouton + pour preparer un exercice.
        </p>

        <div *ngFor="let ex of newExercises; let i = index; trackBy: trackExercise" class="exercise-card">
            <header>
                <h4>Exercice {{ i + 1 }}</h4>
                <div class="exercise-card-actions">
                    <button type="button" (click)="moveNewExerciseUp(i)">Monter</button>
                    <button type="button" (click)="moveNewExerciseDown(i)">Descendre</button>
                    <button type="button" (click)="removeNewExercise(i)">Supprimer</button>
                </div>
            </header>

            <div class="grid">
                <label class="field">
                    <span>Nom</span>
                    <input type="text" [(ngModel)]="ex.name" placeholder="Nom de l exercice" />
                </label>
                <label class="field">
                    <span>Type</span>
                    <select [(ngModel)]="ex.type">
                        <option *ngFor="let opt of exerciseTypes" [ngValue]="opt">{{ opt }}</option>
                    </select>
                </label>
                <label class="field">
                    <span>Series</span>
                    <input type="number" [(ngModel)]="ex.sets" min="1" />
                </label>
                <label class="field">
                    <span>Repetitions</span>
                    <input type="number" [(ngModel)]="ex.reps" min="1" />
                </label>
                <label class="field">
                    <span>Travail (sec)</span>
                    <input type="number" [(ngModel)]="ex.workSec" min="0" />
                </label>
                <label class="field">
                    <span>Repos (sec)</span>
                    <input type="number" [(ngModel)]="ex.restSec" min="0" />
                </label>
                <label class="field">
                    <span>Charge (kg)</span>
                    <input type="number" [(ngModel)]="ex.loadKg" min="0" step="0.5" />
                </label>
                <label class="field">
                    <span>RPE</span>
                    <input type="number" [(ngModel)]="ex.rpe" min="0" max="10" />
                </label>
                <label class="field">
                    <span>Zone cardiaque</span>
                    <input type="text" [(ngModel)]="ex.hrZone" placeholder="Zone 2, 70%..." />
                </label>
            </div>

            <label class="field">
                <span>Notes</span>
                <textarea rows="3" [(ngModel)]="ex.notes" placeholder="Consignes, sensations..."></textarea>
            </label>

            <div class="grid video-grid">
                <label class="field">
                    <span>Video - URL</span>
                    <input type="text" [(ngModel)]="ex.videoUrl" placeholder="Lien video" />
                </label>
                <label class="field">
                    <span>Video - Nom</span>
                    <input type="text" [(ngModel)]="ex.videoName" placeholder="Nom affiche" />
                </label>
                <label class="field">
                    <span>Video - Duree (sec)</span>
                    <input type="number" [(ngModel)]="ex.videoDuration" min="0" />
                </label>
            </div>
        </div>

        <div class="submit-line">
            <button type="button" (click)="handleCreatePlanClient()" [disabled]="planClientLoading">
                {{ planClientLoading ? 'En cours...' : 'Enregistrer le plan' }}
            </button>
        </div>
    </section>

    <section *ngIf="mode === 'manage'" class="manage-panel">
        <div class="messages">
            <p *ngIf="listLoading" class="msg info">Chargement...</p>
            <p *ngIf="listError" class="msg error">{{ listError }}</p>
        </div>

        <p *ngIf="!listLoading && !listError && plans.length === 0" class="empty-hint">
            Aucun plan trouve pour ce client.
        </p>

        <article *ngFor="let plan of plans; trackBy: trackPlan" class="plan-card">
            <header class="plan-card-header">
                <div>
                    <h3>{{ planTitle(plan) }}</h3>
                    <small *ngIf="plan.createdAt">{{ formatDate(plan.createdAt) }}</small>
                </div>
                <div class="plan-card-actions">
                    <button type="button" (click)="togglePlan(plan)">
                        {{ plan.expanded ? 'Fermer' : 'Voir' }}
                    </button>
                    <button type="button" (click)="openDeletePlan(plan)">Supprimer le plan</button>
                </div>
            </header>

            <div *ngIf="plan.expanded" class="plan-card-body">
                <div class="messages">
                    <p *ngIf="plan.message" class="msg success">{{ plan.message }}</p>
                    <p *ngIf="plan.error" class="msg error">{{ plan.error }}</p>
                </div>

                <div class="exercise-actions">
                    <button type="button" (click)="addExerciseToPlan(plan)" [disabled]="plan.busy">
                        + Ajouter un exercice
                    </button>
                </div>

                <div *ngFor="let ex of plan.exercisesForm; let i = index; trackBy: trackExercise" class="exercise-card">
                    <header>
                        <h4>Exercice {{ i + 1 }}</h4>
                        <div class="exercise-card-actions">
                            <button type="button" (click)="moveExercise(plan, i, 'up')" [disabled]="plan.busy || ex.saving">Monter</button>
                            <button type="button" (click)="moveExercise(plan, i, 'down')" [disabled]="plan.busy || ex.saving">Descendre</button>
                            <button type="button" (click)="removeExercise(plan, ex)" [disabled]="ex.saving">Supprimer</button>
                        </div>
                    </header>

                    <div class="grid">
                        <label class="field">
                            <span>Nom</span>
                            <input type="text" [(ngModel)]="ex.name" />
                        </label>
                        <label class="field">
                            <span>Type</span>
                            <select [(ngModel)]="ex.type">
                                <option *ngFor="let opt of exerciseTypes" [ngValue]="opt">{{ opt }}</option>
                            </select>
                        </label>
                        <label class="field">
                            <span>Series</span>
                            <input type="number" [(ngModel)]="ex.sets" min="1" />
                        </label>
                        <label class="field">
                            <span>Repetitions</span>
                            <input type="number" [(ngModel)]="ex.reps" min="1" />
                        </label>
                        <label class="field">
                            <span>Travail (sec)</span>
                            <input type="number" [(ngModel)]="ex.workSec" min="0" />
                        </label>
                        <label class="field">
                            <span>Repos (sec)</span>
                            <input type="number" [(ngModel)]="ex.restSec" min="0" />
                        </label>
                        <label class="field">
                            <span>Charge (kg)</span>
                            <input type="number" [(ngModel)]="ex.loadKg" min="0" step="0.5" />
                        </label>
                        <label class="field">
                            <span>RPE</span>
                            <input type="number" [(ngModel)]="ex.rpe" min="0" max="10" />
                        </label>
                        <label class="field">
                            <span>Zone cardiaque</span>
                            <input type="text" [(ngModel)]="ex.hrZone" />
                        </label>
                    </div>

                    <label class="field">
                        <span>Notes</span>
                        <textarea rows="3" [(ngModel)]="ex.notes"></textarea>
                    </label>

                    <div class="grid video-grid">
                        <label class="field">
                            <span>Video - URL</span>
                            <input type="text" [(ngModel)]="ex.videoUrl" />
                        </label>
                        <label class="field">
                            <span>Video - Nom</span>
                            <input type="text" [(ngModel)]="ex.videoName" />
                        </label>
                        <label class="field">
                            <span>Video - Duree (sec)</span>
                            <input type="number" [(ngModel)]="ex.videoDuration" min="0" />
                        </label>
                    </div>

                    <div class="messages">
                        <p *ngIf="ex.success" class="msg success">{{ ex.success }}</p>
                        <p *ngIf="ex.error" class="msg error">{{ ex.error }}</p>
                    </div>

                    <div class="submit-line">
                        <button type="button" (click)="saveExercise(plan, ex)" [disabled]="ex.saving">
                            {{ ex.saving ? 'En cours...' : 'Enregistrer cet exercice' }}
                        </button>
                    </div>
                </div>

                <div class="videos-block" *ngIf="plan.videos.length > 0">
                    <h5>Videos attachees</h5>
                    <ul>
                        <li *ngFor="let vid of plan.videos">
                            <a [href]="vid.url" target="_blank" rel="noopener">{{ vid.name || 'Video' }}</a>
                            <span *ngIf="vid.duration">- {{ vid.duration }}s</span>
                            <button type="button" (click)="detachVideo(plan, vid.videoId)" [disabled]="plan.busy">Retirer</button>
                        </li>
                    </ul>
                </div>

                <div class="exercise-actions">
                    <button type="button" (click)="openPlanVideoPicker(plan._id)">
                        + Ajouter une video
                    </button>
                </div>
            </div>
        </article>

        <div class="messages video-messages">
            <p *ngIf="videoUploadLoading" class="msg info">Upload video en cours...</p>
            <p *ngIf="videoUploadSuccess" class="msg success">{{ videoUploadSuccess }}</p>
            <p *ngIf="videoUploadError" class="msg error">{{ videoUploadError }}</p>
        </div>
    </section>
</div>

<input #planVideoInput type="file" accept="video/*" class="hidden" (change)="handleVideoPicked($event)" multiple />

<div *ngIf="deleteConfirmOpen" class="modal-backdrop" (click)="cancelDeletePlan()">
    <div class="modal" (click)="$event.stopPropagation()">
        <h3>Confirmer la suppression</h3>
        <p>Supprimer le plan "{{ deleteTargetTitle }}" ?</p>
        <p *ngIf="deleteError" class="msg error">{{ deleteError }}</p>
        <div class="modal-actions">
            <button type="button" (click)="cancelDeletePlan()">Annuler</button>
            <button type="button" (click)="confirmDeletePlan()">Supprimer</button>
        </div>
    </div>
</div>
