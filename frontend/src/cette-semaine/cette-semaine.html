<div class="min-h-svh bg-gradient-to-b from-[#315f92] to-[#24476e]">
    <header class="sticky top-0 z-10 px-4 pt-4 pb-3 bg-gradient-to-b from-[#315f92] to-transparent">
        <div class="flex items-center justify-between text-white">
            <a routerLink="/accueil" class="rounded-full p-2 hover:bg-white/10 active:scale-95">
                <svg viewBox="0 0 24 24" class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 19l-7-7 7-7" />
                </svg>
            </a>

            <div class="text-right">
                <h1 class="text-base font-bold leading-tight uppercase">Cette semaine</h1>
            </div>
        </div>
    </header>

    <main class="-mt-2 rounded-t-3xl bg-white p-4 pt-6">

        <section id="resume" class="scroll-mt-20">
            <h2 class="text-base font-semibold text-[#315f92] mb-3">R√©sum√© de la semaine</h2>

            <p class="text-sm text-[#527bab]" *ngIf="loading">Chargement‚Ä¶</p>
            <p class="rounded-xl border border-red-200 bg-red-50 px-4 py-2 text-sm text-red-700" *ngIf="error">
                {{ error }}
            </p>

            <ng-container *ngIf="!loading && !error">
                <div *ngIf="semaines && semaines.length > 0; else noWeekly"
                    class="rounded-2xl border border-[#e1e9f5] bg-white p-4 text-[#315f92] shadow-sm">
                    <header class="mb-3 flex flex-wrap items-center justify-between gap-2">
                        <h3 class="text-base font-semibold">
                            {{ (semaines[0].title && semaines[0].title.trim()) ? semaines[0].title : 'Votre semaine' }}
                        </h3>
                        <small class="text-[#527bab]">{{ formatDate(semaines[0].createdAt) }}</small>
                    </header>

                    <div class="content-html prose max-w-none prose-p:my-2 prose-ul:list-disc prose-ol:list-decimal prose-li:my-1"
                        [innerHTML]="sanitize(semaines[0].contenu)">
                    </div>

                </div>

                <ng-template #noWeekly>
                    <p class="text-sm text-[#527bab]">
                        Aucun ‚Äúcette semaine‚Äù pour le moment. Revenez bient√¥t üëÄ
                    </p>
                </ng-template>
            </ng-container>
        </section>

        <section id="exercices" class="mt-8 scroll-mt-20">
            <h2 class="text-base font-semibold text-[#315f92] mb-3">Vos exercices</h2>

            <p class="text-sm text-[#527bab]" *ngIf="loading">Chargement‚Ä¶</p>
            <p class="rounded-xl border border-red-200 bg-red-50 px-4 py-2 text-sm text-red-700" *ngIf="error">{{ error }}</p>

            <p class="text-sm text-[#527bab]" *ngIf="!loading && !error && sessions.length === 0">
                Aucun exercice disponible pour le moment.
            </p>

            <section *ngFor="let s of sessions; let i = index; trackBy: trackById"
                class="rounded-2xl border border-[#e1e9f5] bg-white shadow-sm mb-3">
                <button type="button"
                    class="w-full flex items-center justify-between gap-3 px-4 py-3 text-left text-[#315f92]"
                    (click)="toggle(s._id)">
                    <div class="min-w-0">
                        <div class="font-semibold truncate">
                            {{ planTitle(s, i) }}
                        </div>
                        <div class="text-xs text-[#527bab]">{{ formatDate(s.createdAt) }}</div>
                    </div>

                    <svg [ngClass]="{ 'rotate-180': expandedId === s._id }"
                        class="h-4 w-4 transition-transform shrink-0" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6" />
                    </svg>
                </button>

                <div *ngIf="expandedId === s._id" class="px-4 pb-4 space-y-4">
                    <div *ngIf="s.contenu" class="content-html prose max-w-none prose-p:my-2 prose-ul:list-disc prose-ol:list-decimal prose-li:my-1"
                        [innerHTML]="sanitize(s.contenu)">
                    </div>
                    <ng-container *ngIf="s.exercises && s.exercises.length > 0; else noExercises">
                        <article *ngFor="let ex of s.exercises; let idx = index"
                            class="rounded-xl border border-[#e1e9f5] bg-[#f8faff] p-3 space-y-2 text-[#315f92]">
                            <h4 class="text-sm font-semibold">{{ exerciseTitle(ex, idx) }}</h4>
                            <ul class="text-xs text-[#527bab] space-y-1 leading-relaxed">
                                <li *ngIf="formatSetsReps(ex)">{{ formatSetsReps(ex) }}</li>
                                <li>Temps travail : {{ formatSeconds(ex.workSec) }}</li>
                                <li>Repos : {{ formatSeconds(ex.restSec) }}</li>
                                <li>{{ formatLoad(ex.loadKg) }}</li>
                                <li *ngIf="ex.hrZone">Zone cardiaque : {{ ex.hrZone }}</li>
                                <li *ngIf="ex.rpe && ex.rpe > 0">RPE : {{ ex.rpe }}</li>
                            </ul>

                            <a *ngIf="hasVideo(ex)" [href]="ex.video.url" target="_blank" rel="noopener"
                                class="inline-flex items-center gap-2 text-xs font-semibold text-[#315f92] underline">
                                {{ videoLabel(ex) }}
                            </a>

                            <div *ngIf="ex.notes" class="rounded-lg bg-[#315f92]/10 px-3 py-2 text-xs">
                                <strong class="block text-[#315f92] mb-1">Consignes :</strong>
                                <p class="text-[#315f92] whitespace-pre-wrap">{{ ex.notes }}</p>
                            </div>
                        </article>
                    </ng-container>

                    <ng-template #noExercises>
                        <p class="text-xs text-[#527bab]">Aucun exercice enregistr√© pour cette seance.</p>
                    </ng-template>

                    <div *ngIf="s.videos && s.videos.length > 0" class="space-y-2">
                        <h5 class="text-sm font-semibold text-[#315f92]">Videos</h5>
                        <div *ngFor="let v of s.videos"
                            class="flex items-center justify-between gap-3 rounded-xl border border-[#e1e9f5] bg-[#f7f9fe] px-3 py-2">
                            <div class="min-w-0">
                                <a [href]="v.url" target="_blank" rel="noopener"
                                    class="block truncate text-sm underline decoration-[#315f92] underline-offset-4">
                                    {{ v.name || 'Video' }}
                                </a>
                                <small *ngIf="v.duration && v.duration > 0" class="text-[#527bab]">{{ v.duration }}s</small>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <div class="h-20"></div>
        </section>
    </main>

    <nav class="fixed inset-x-0 bottom-0 z-20 mx-auto max-w-md px-4 pb-4">
        <div class="mx-auto rounded-2xl bg-white/95 backdrop-blur shadow-lg border border-gray-100">
            <div class="grid grid-cols-3">
                <a routerLink="/accueil" class="flex flex-col items-center py-2.5 text-[#315f92]">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12l9-9 9 9" />
                        <path d="M9 21V9h6v12" />
                    </svg>
                    <span class="text-[11px] font-medium">Accueil</span>
                </a>

                <ng-container *ngIf="getChatLink() as chatLink; else msgTabDisabled">
                    <a [routerLink]="chatLink"
                        class="relative flex flex-col items-center py-2.5 text-gray-500 hover:text-[#315f92]">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a4 4 0 0 1-4 4H7l-4 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z" />
                        </svg>
                        <span class="text-[11px] font-medium">Messages</span>
                        <span *ngIf="nombreNonLus > 0"
                            class="absolute top-1 right-10 inline-flex h-2 w-2 rounded-full bg-red-500"
                            title="Nouveaux messages"></span>
                    </a>
                </ng-container>

                <ng-template #msgTabDisabled>
                    <div class="flex flex-col items-center py-2.5 text-gray-400 opacity-50 pointer-events-none">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a4 4 0 0 1-4 4H7l-4 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z" />
                        </svg>
                        <span class="text-[11px] font-medium">Messages</span>
                    </div>
                </ng-template>

                <a routerLink="/rdv" class="flex flex-col items-center py-2.5 text-gray-500 hover:text-[#315f92]">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" />
                        <path d="M16 2v4M8 2v4M3 10h18" />
                    </svg>
                    <span class="text-[11px] font-medium">RDV</span>
                </a>
            </div>
        </div>
    </nav>
</div>
